<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PeerRank.ai - LLM Peer Evaluation Leaderboard</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
</head>
<body>
    <div class="gradient-bg"></div>

    <header>
        <div class="container">
            <h1>PeerRank<span class="accent">.ai</span></h1>
            <p class="tagline">What do AIs think about their peers? And who is the most generous judge?</p>
            <div class="badges">
                <span class="badge">{{ metadata.models_count }} Models</span>
                <span class="badge">{{ metadata.questions_count }} Questions</span>
                <span class="badge {% if metadata.web_search == 'ON' %}badge-green{% else %}badge-orange{% endif %}">
                    Web Search: {{ metadata.web_search }}
                </span>
                <button class="badge badge-about" onclick="document.getElementById('aboutModal').classList.add('show')">
                    &#9432; About
                </button>
            </div>
        </div>
    </header>

    <main class="container">
        <!-- Leaderboard Section -->
        <section class="leaderboard-section">
            <div class="section-header">
                <h2>Leaderboard</h2>
            </div>

            <div class="leaderboard-grid">
                <!-- Elo Rankings -->
                <div class="card">
                    <div class="card-header">
                        <h3>Rated by Peer LLMs</h3>
                        <span class="card-badge">{{ metadata.generated }}</span>
                    </div>
                    <div class="table-container">
                        <table class="rankings-table">
                            <thead>
                                <tr>
                                    <th class="col-rank">#</th>
                                    <th class="col-model">Model</th>
                                    <th class="col-elo">Elo</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in elo_rankings %}
                                <tr class="{% if row.rank == 1 %}rank-gold{% elif row.rank == 2 %}rank-silver{% elif row.rank == 3 %}rank-bronze{% endif %}">
                                    <td class="col-rank">
                                        {% if row.rank == 1 %}
                                        <span class="medal gold">&#128081;</span>
                                        {% elif row.rank == 2 %}
                                        <span class="medal silver">&#129352;</span>
                                        {% elif row.rank == 3 %}
                                        <span class="medal bronze">&#129353;</span>
                                        {% else %}
                                        {{ row.rank }}
                                        {% endif %}
                                    </td>
                                    <td class="col-model">{{ row.model }}</td>
                                    <td class="col-elo mono">{{ row.elo }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Judge Generosity (Elo order, crowns for top 3 generous) -->
                <div class="card card-narrow">
                    <div class="card-header">
                        <h3>Judge Generosity</h3>
                        <span class="card-badge">{{ metadata.generated }}</span>
                    </div>
                    <div class="table-container">
                        <table class="rankings-table generosity-table">
                            <thead>
                                <tr>
                                    <th class="col-rank">#</th>
                                    <th class="col-score">Avg Given</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in elo_rankings %}
                                {% set gen = generosity_by_model.get(row.model, {}) %}
                                {% set gen_rank = gen.rank|default(99) %}
                                <tr class="generosity-row {% if gen_rank == 1 %}rank-gold{% elif gen_rank == 2 %}rank-silver{% elif gen_rank == 3 %}rank-bronze{% endif %}">
                                    <td class="col-rank">
                                        {% if gen_rank == 1 %}
                                        <span class="medal gold">&#128081;</span>
                                        {% elif gen_rank == 2 %}
                                        <span class="medal silver">&#129352;</span>
                                        {% elif gen_rank == 3 %}
                                        <span class="medal bronze">&#129353;</span>
                                        {% else %}
                                        {{ gen_rank }}
                                        {% endif %}
                                    </td>
                                    <td class="col-score">
                                        <div class="generosity-bar">
                                            <div class="generosity-fill">
                                                <div class="generosity-fill-inner" style="width: {{ ((gen.avg_given|default(7) - 5) / 5 * 100)|int }}%;"></div>
                                            </div>
                                            <span class="generosity-value mono">{{ "%.2f"|format(gen.avg_given|default(0)) }}</span>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- API Latency (Elo order, crowns for top 3 fastest) -->
                <div class="card">
                    <div class="card-header">
                        <h3>Response Time</h3>
                        <span class="card-badge" id="latency-updated">Live</span>
                    </div>
                    <div class="table-container">
                        <table class="rankings-table latency-table" id="latency-table">
                            <thead>
                                <tr>
                                    <th class="col-rank">#</th>
                                    <th class="col-model">Model</th>
                                    <th class="col-latency">Latency</th>
                                </tr>
                            </thead>
                            <tbody id="latency-body">
                                {% for row in elo_rankings %}
                                <tr data-model="{{ row.model }}">
                                    <td class="col-rank">{{ row.rank }}</td>
                                    <td class="col-model">{{ row.model }}</td>
                                    <td class="col-latency mono">—</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- Bias Analysis Section -->
        <section class="bias-section">
            <div class="section-header">
                <h2>Bias Analysis</h2>
                <p>Detecting self-favoritism, brand recognition, and position effects</p>
            </div>

            <div class="bias-grid">
                <!-- Model Bias (Self & Name) -->
                <div class="card card-wide">
                    <div class="card-header">
                        <h3>Model Bias</h3>
                        <span class="card-badge">{{ metadata.generated }}</span>
                    </div>
                    <div class="table-container">
                        <table class="bias-table">
                            <thead>
                                <tr>
                                    <th class="col-rank">#</th>
                                    <th class="col-model">Model</th>
                                    <th class="col-score">PEER ONLY</th>
                                    <th class="col-score">PEER+SELF</th>
                                    <th class="col-bias">Self Bias</th>
                                    <th class="col-score">ANONYMOUS</th>
                                    <th class="col-bias">BRAND BIAS</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in model_bias %}
                                <tr>
                                    <td class="col-rank">{{ row.rank }}</td>
                                    <td class="col-model">{{ row.model }}</td>
                                    <td class="col-score mono">{{ "%.2f"|format(row.peer) }}</td>
                                    <td class="col-score mono">{{ "%.2f"|format(row.self) }}</td>
                                    <td class="col-bias mono {% if row.self_bias.startswith('+') %}bias-positive{% elif row.self_bias.startswith('-') %}bias-negative{% endif %}">
                                        {{ row.self_bias }}
                                    </td>
                                    <td class="col-score mono">{{ "%.2f"|format(row.shuffle) }}</td>
                                    <td class="col-bias mono {% if row.name_bias.startswith('+') %}bias-positive{% elif row.name_bias.startswith('-') %}bias-negative{% endif %}">
                                        {{ row.name_bias }}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="card-footer">
                        <span class="legend"><span class="dot positive"></span> Positive = overrated self / name helped</span>
                        <span class="legend"><span class="dot negative"></span> Negative = underrated self / name hurt</span>
                    </div>
                </div>

            </div>
        </section>
    </main>

    <footer>
        <div class="container">
            <p>Generated {{ generation_time }} | <a href="https://github.com/yourusername/peerrank">GitHub</a></p>
        </div>
    </footer>

    <!-- About Modal -->
    <div id="aboutModal" class="modal" onclick="if(event.target===this)this.classList.remove('show')">
        <div class="modal-content">
            <button class="modal-close" onclick="document.getElementById('aboutModal').classList.remove('show')">&times;</button>
            <h2>About PeerRank</h2>
            <p class="modal-subtitle">Fully Endogenous LLM Evaluation</p>

            <div class="about-section">
                <h3>How It Works</h3>
                <div class="about-steps">
                    <div class="about-step">
                        <span class="step-num">1</span>
                        <div>
                            <strong>Question Generation</strong>
                            <p>Each LLM generates challenging questions across multiple categories</p>
                        </div>
                    </div>
                    <div class="about-step">
                        <span class="step-num">2</span>
                        <div>
                            <strong>Answer Collection</strong>
                            <p>All models answer all questions with web search enabled</p>
                        </div>
                    </div>
                    <div class="about-step">
                        <span class="step-num">3</span>
                        <div>
                            <strong>Peer Evaluation</strong>
                            <p>Each model evaluates every other model's responses (1-10 scale)</p>
                        </div>
                    </div>
                    <div class="about-step">
                        <span class="step-num">4</span>
                        <div>
                            <strong>Bias Detection</strong>
                            <p>Three evaluation modes detect self-favoritism, brand bias, and position effects</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="about-section">
                <h3>Bias Modes</h3>
                <ul class="about-list">
                    <li><strong>PEER ONLY:</strong> Scores from other models only (self-ratings excluded)</li>
                    <li><strong>PEER+SELF:</strong> Includes model's rating of its own response</li>
                    <li><strong>ANONYMOUS:</strong> Model names hidden during evaluation</li>
                </ul>
            </div>

            <div class="about-section">
                <h3>Key Metrics</h3>
                <ul class="about-list">
                    <li><strong>Elo Rating:</strong> Pairwise comparison ranking from head-to-head evaluations</li>
                    <li><strong>Self Bias:</strong> How much a model overrates its own responses</li>
                    <li><strong>Brand Bias:</strong> Score change when model names are visible vs hidden</li>
                    <li><strong>Judge Generosity:</strong> Average score a model gives when evaluating others</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // Load and display latency data (keeps Elo order, crowns 3 fastest)
        async function loadLatencyData() {
            const badge = document.getElementById('latency-updated');
            const rows = document.querySelectorAll('#latency-body tr[data-model]');
            try {
                const response = await fetch('latency.json?' + Date.now());
                if (!response.ok) throw new Error('No data');
                const data = await response.json();

                // Update timestamp badge
                if (data.last_updated) {
                    const ago = Math.round((Date.now() - new Date(data.last_updated).getTime()) / 1000);
                    badge.textContent = ago < 60 ? `${ago}s ago` : `${Math.round(ago/60)}m ago`;
                }

                const results = data.current?.results || {};

                // Rank ALL models by speed
                const sorted = Object.entries(results)
                    .filter(([_, info]) => info.latency_ms != null)
                    .sort((a, b) => a[1].latency_ms - b[1].latency_ms);
                const speedRanks = Object.fromEntries(sorted.map(([name], i) => [name, i + 1]));

                const medals = {1: '&#128081;', 2: '&#129352;', 3: '&#129353;'};
                const rankClasses = {1: 'rank-gold', 2: 'rank-silver', 3: 'rank-bronze'};
                const medalClasses = {1: 'gold', 2: 'silver', 3: 'bronze'};

                // Update each row
                rows.forEach(row => {
                    const model = row.dataset.model;
                    const result = results[model];
                    const latencyMs = result?.latency_ms;
                    const speedRank = speedRanks[model];

                    // Update latency cell
                    const latCell = row.querySelector('.col-latency');
                    if (latencyMs != null) {
                        const str = latencyMs < 1000 ? `${latencyMs}ms` : `${(latencyMs/1000).toFixed(1)}s`;
                        const cls = latencyMs < 1000 ? 'latency-fast' : latencyMs < 3000 ? 'latency-medium' : 'latency-slow';
                        latCell.textContent = str;
                        latCell.className = `col-latency mono ${cls}`;
                    } else {
                        latCell.textContent = '—';
                        latCell.className = 'col-latency mono';
                    }

                    // Update rank cell - crowns for top 3, numbers for rest
                    const rankCell = row.querySelector('.col-rank');
                    row.classList.remove('rank-gold', 'rank-silver', 'rank-bronze');
                    if (speedRank && speedRank <= 3) {
                        row.classList.add(rankClasses[speedRank]);
                        rankCell.innerHTML = `<span class="medal ${medalClasses[speedRank]}">${medals[speedRank]}</span>`;
                    } else if (speedRank) {
                        rankCell.textContent = speedRank;
                    } else {
                        rankCell.textContent = '—';
                    }
                });
            } catch (e) {
                badge.textContent = 'Offline';
            }
        }

        loadLatencyData();
        setInterval(loadLatencyData, 30000);
    </script>
</body>
</html>
